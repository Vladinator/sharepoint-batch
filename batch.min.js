/*!
 * SharePointBatch
 * Copyright 2015 Alex Pedersen
 * Licensed under the MIT license
 * https://github.com/Vladinator89/sharepoint-batch
 */
!function(){"use strict";function t(i){function p(t){function o(){p.push("--batch_"+this.guid),p.push("Content-Type: application/http"),p.push("Content-Transfer-Encoding: binary"),p.push("");for(var s=0;s<t.changesets.length;s++){p.push(t.method+" "+t.url+e(t.params)+" HTTP/1.1"),p.push("Accept: application/json;odata=verbose");for(var n in t.headers)t.headers.hasOwnProperty(n)&&p.push(n+": "+t.headers[n]);p.push("")}}function r(){var o="changeset_"+s();p.push("--batch_"+this.guid),p.push('Content-Type: multipart/mixed; boundary="'+o+'"'),p.push("Content-Transfer-Encoding: binary"),p.push("");for(var a=0;a<t.changesets.length;a++){var r=t.changesets[a];p.push("--"+o),p.push("Content-Type: application/http"),p.push("Content-Transfer-Encoding: binary"),p.push(""),p.push(t.method+" "+t.url+e(t.params)+" HTTP/1.1"),p.push("Accept: application/json;odata=verbose"),p.push("Content-Type: application/json;odata=verbose");var i=n({},t.headers);n(i,r.headers);for(var h in i)i.hasOwnProperty(h)&&p.push(h+": "+i[h]);p.push(""),null!==r.data&&(p.push(JSON.stringify(r.data)),p.push(""))}p.push("--"+o+"--")}function i(){return p.join("\r\n")}t=n({guid:s(),method:"GET",url:"",headers:{},changesets:[],args:{}},t),n(t,{payload:i,toString:i});var p=[];return a(t.changesets)&&t.changesets.length||(t.changesets=[null]),("GET"!==t.method?r:o).call(this),this.jobs.push(t)-1}function h(t){return"number"==typeof t?this.jobs.splice(t,1):void 0}function u(){for(var t="",s=0;s<this.jobs.length;s++){var e=this.jobs[s];e&&(t+=e.payload()+"\r\n")}return t}function c(t){function s(t){if("string"!=typeof t)return null;try{return JSON.parse(t)}catch(e){}for(var n={UNKNOWN:0,HEADERS:1,REQUEST:2,REQUEST_HEADERS:3,REQUEST_BODY:4,EOF:5},o=t.split(/\r\n/),a=[],r=void 0,i=void 0,p=n.UNKNOWN,h=0;h<o.length;h++){var u=o[h];if(/^--batchresponse_.+--$/i.test(u)){void 0!==r&&(r.data=s.call(this,r.data),a.push(r),r=void 0),p=n.EOF;break}if(/^--batchresponse_.+$/i.test(u))void 0!==r&&(r.data=s.call(this,r.data),a.push(r)),r={headers:{},http:{status:0,statusText:""},data:void 0},i=r,p=n.HEADERS;else if(p===n.REQUEST_BODY)void 0===i.data&&(i.data=""),i.data+=u;else if(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i.test(u)){if(p===n.REQUEST){var c=u.match(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i);i.http.status=parseInt(c[1],10),i.http.statusText=c[2],p=n.REQUEST_HEADERS}}else if(/^.+:\s*.+$/i.test(u)){if(p===n.HEADERS||p===n.REQUEST_HEADERS){var l=u.split(/:/),f=l.shift(1).trim(),d=l.join(":").trim();i.headers[f]=d}}else/^[\s\r\n]*$/i.test(u)&&(p===n.HEADERS?p=n.REQUEST:p===n.REQUEST?p=n.REQUEST_HEADERS:p===n.REQUEST_HEADERS&&(p=n.REQUEST_BODY))}return a}function e(t){for(var s=0,e=0;e<this.jobs.length;e++){var n=this.jobs[e];if(a(n.changesetResults))for(;n.changesetResults.length;)n.changesetResults.pop();else n.changesetResults=[];for(var r=0;r<n.changesets.length;r++){var i=t[s++];o(i,!0)&&(i.job=n,i.changeset=r),n.changesetResults.push(i)}}}t=n({method:"POST",url:this.options.url+"/_api/$batch",headers:{"X-RequestDigest":this.options.digest,"Content-Type":'multipart/mixed; boundary="batch_'+this.guid+'"'},data:this.payload()+"--batch_"+this.guid+"--"},t);var i=n({},t);return t.done=function(t){t.responseJSON=s.call(this,t.responseText),e.call(this,t.responseJSON),Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof i.done&&i.done.apply(this,arguments)},t.fail=function(t){t.responseJSON=s.call(this,t.responseText),e.call(this,t.responseJSON),Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof i.fail&&i.fail.apply(this,arguments)},t.always=function(t){Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof i.always&&i.always.apply(this,arguments)},r.call(this,t)}function l(s){return new t(n(n({},this.options),s))}n(this,{options:n({url:"",digest:""},i),guid:s(),jobs:[],append:p,remove:h,payload:u,toString:u,send:c,spawn:l})}function s(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=16*Math.random()|0;return("x"==t?s:3&s|8).toString(16)})}function e(t){var s="";if(o(t))for(var e in t){var n="";try{n=encodeURIComponent(t[e])}catch(a){}s+=(""===s?"?":"&")+e+"="+n}return s}function n(t,s,e){var r=t===!0,i=r?s:t,p=r?e:s;if(o(i)||"function"==typeof i||(i={}),o(p)){var h,u,c;for(var l in p)u=p[l],h=i[l],c=a(u),u!==h&&(r&&u&&(o(u)||c)?n(r,i[l],u):void 0!==u&&(i[l]=u))}return i}function o(t,s){return t&&"object"==typeof t&&(!s||t.constructor===window.Object)}function a(t){return t&&"object"==typeof t&&t.constructor===window.Array}function r(t){function s(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.progress&&this.options.progress.apply(this.options.batch,arguments)}function e(){return 2!==(this.status/100|0)?a.apply(this,arguments):(Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.done&&this.options.done.apply(this.options.batch,arguments),"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments),void("function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)))}function a(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.fail&&this.options.fail.apply(this.options.batch,arguments),"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments),"function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)}t=n({},t);var r=new XMLHttpRequest;if(t.batch=this,r.options=t,t.xhr=r,r.addEventListener("progress",s),r.addEventListener("load",e),r.addEventListener("error",a),r.addEventListener("abort",a),r.open(t.method,t.url),r.setRequestHeader("Accept","application/json;odata=verbose"),o(t.headers))for(var i in t.headers)t.headers.hasOwnProperty(i)&&r.setRequestHeader(i,t.headers[i]);return t.mime&&r.overrideMimeType(t.mime),"function"==typeof t.before&&t.before.call(t.batch,r),r.send(t.data),r}t.prototype.toParams=e,t.prototype.extend=n,t.prototype.isObject=o,t.prototype.isArray=a,t.prototype.ajax=r,window.SharePointBatch=t}();
