/*!
 * SharePointBatch
 * Copyright 2016 Alex Pedersen
 * Licensed under the MIT license
 * https://github.com/Vladinator89/sharepoint-batch
 */
!function(){"use strict";function a(h){function i(a){function h(){e.push("--batch_"+this.guid),e.push("Content-Type: application/http"),e.push("Content-Transfer-Encoding: binary"),e.push("");for(var b=0;b<a.changesets.length;b++){e.push(a.method+" "+a.url+c(a.params)+" HTTP/1.1"),e.push("Accept: application/json;odata=verbose");for(var d in a.headers)a.headers.hasOwnProperty(d)&&e.push(d+": "+a.headers[d]);e.push("")}}function i(){var f="changeset_"+b();e.push("--batch_"+this.guid),e.push('Content-Type: multipart/mixed; boundary="'+f+'"'),e.push("Content-Transfer-Encoding: binary"),e.push("");for(var g=0;g<a.changesets.length;g++){var h=a.changesets[g];e.push("--"+f),e.push("Content-Type: application/http"),e.push("Content-Transfer-Encoding: binary"),e.push(""),e.push(a.method+" "+a.url+c(a.params)+" HTTP/1.1"),e.push("Accept: application/json;odata=verbose"),e.push("Content-Type: application/json;odata=verbose");var i=null!==h&&null!==h.data?JSON.stringify(h.data):null,j=a.headers;null!==h&&(j=d({},a.headers),d(j,h.headers));for(var k in j)j.hasOwnProperty(k)&&e.push(k+": "+j[k]);e.push(""),i&&(e.push(i),e.push(""))}e.push("--"+f+"--")}function j(){return e.join("\r\n")}a=d({guid:b(),method:"GET",url:"",headers:{},changesets:[],args:{}},a),d(a,{payload:j,toString:j});var e=[];f(a.changesets)&&a.changesets.length||(a.changesets=[null]),("GET"!==a.method?i:h).call(this);var g=this.changesetSlots;return g-=a.changesets.length,g<0?-1:(this.changesetSlots=g,this.jobs.push(a)-1)}function j(a){if("number"==typeof a)return this.jobs.splice(a,1)}function k(){for(var a="",b=0;b<this.jobs.length;b++){var c=this.jobs[b];c&&(a+=c.payload()+"\r\n")}return a}function l(a){function c(a){if("string"!=typeof a)return null;try{return JSON.parse(a)}catch(a){}for(var b={UNKNOWN:0,HEADERS:1,REQUEST:2,REQUEST_HEADERS:3,REQUEST_BODY:4,EOF:5},d=a.split(/\r\n/),e=[],f=void 0,g=void 0,h=b.UNKNOWN,i=0;i<d.length;i++){var j=d[i];if(/^--batchresponse_.+--$/i.test(j)){void 0!==f&&(f.data=c.call(this,f.data),e.push(f),f=void 0),h=b.EOF;break}if(/^--batchresponse_.+$/i.test(j))void 0!==f&&(f.data=c.call(this,f.data),e.push(f)),f={headers:{},http:{status:0,statusText:""},data:void 0},g=f,h=b.HEADERS;else if(h===b.REQUEST_BODY)void 0===g.data&&(g.data=""),g.data+=j;else if(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i.test(j)){if(h===b.REQUEST){var k=j.match(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i);g.http.status=parseInt(k[1],10),g.http.statusText=k[2],h=b.REQUEST_HEADERS}}else if(/^.+:\s*.+$/i.test(j)){if(h===b.HEADERS||h===b.REQUEST_HEADERS){var l=j.split(/:/),m=l.shift(1).trim(),n=l.join(":").trim();g.headers[m]=n}}else/^[\s\r\n]*$/i.test(j)&&(h===b.HEADERS?h=b.REQUEST:h===b.REQUEST?h=b.REQUEST_HEADERS:h===b.REQUEST_HEADERS&&(h=b.REQUEST_BODY))}return e}function h(a){for(var b=0,c=0;c<this.jobs.length;c++){var d=this.jobs[c];if(f(d.changesetResults))for(;d.changesetResults.length;)d.changesetResults.pop();else d.changesetResults=[];for(var g=0;g<d.changesets.length;g++){var h=a[b++];e(h,!0)&&(h.job=d,h.changeset=g),d.changesetResults.push(h)}}}a=d({method:"POST",url:this.options.url+"/_api/$batch",headers:{"X-RequestDigest":this.options.digest,"Content-Type":'multipart/mixed; boundary="batch_'+this.guid+'"'},data:this.payload()+"--batch_"+this.guid+"--"},a);var b=d({},a);return a.done=function(a){a.responseJSON=c.call(this,a.responseText),h.call(this,a.responseJSON),Array.prototype.push.call(arguments,a.responseJSON),"function"==typeof b.done&&b.done.apply(this,arguments)},a.fail=function(a){a.responseJSON=c.call(this,a.responseText),h.call(this,a.responseJSON),Array.prototype.push.call(arguments,a.responseJSON),"function"==typeof b.fail&&b.fail.apply(this,arguments)},a.always=function(a){Array.prototype.push.call(arguments,a.responseJSON),"function"==typeof b.always&&b.always.apply(this,arguments)},g.call(this,a)}function m(b){return new a(d(d({},this.options),b))}d(this,{options:d({url:"",digest:""},h),guid:b(),jobs:[],changesetSlots:100,append:i,remove:j,payload:k,toString:k,send:l,spawn:m})}function b(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})}function c(a){var b="";if(e(a))for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];if(f(d))for(var g=0;g<d.length;g++){var h=d[g];try{h=encodeURIComponent(h)}catch(a){h=""}b+=(""===b?"?":"&")+c+"[]="+h}else{try{d=encodeURIComponent(d)}catch(a){d=""}b+=(""===b?"?":"&")+c+"="+d}}return b}function d(a,b,c){var g=a===!0,h=g?b:a,i=g?c:b;if(e(h)||"function"==typeof h||(h={}),e(i)){var j,k,l;for(var m in i)k=i[m],j=h[m],l=f(k),k!==j&&(g&&k&&(e(k)||l)?d(g,h[m],k):void 0!==k&&(h[m]=k))}return h}function e(a,b){return a&&"object"==typeof a&&(!b||!f(a))}function f(a){return Array.isArray(a)}function g(a){function f(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.progress&&this.options.progress.apply(this.options.batch,arguments)}function g(){return 2!==(this.status/100|0)?h.apply(this,arguments):(Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.done&&this.options.done.apply(this.options.batch,arguments),"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments),void("function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)))}function h(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.fail&&this.options.fail.apply(this.options.batch,arguments),"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments),"function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)}a=d({},a);var b=new XMLHttpRequest;if(a.batch=this,b.options=a,a.xhr=b,b.addEventListener("progress",f),b.addEventListener("load",g),b.addEventListener("error",h),b.addEventListener("abort",h),b.open(a.method,a.url),b.setRequestHeader("Accept","application/json;odata=verbose"),e(a.headers))for(var c in a.headers)a.headers.hasOwnProperty(c)&&b.setRequestHeader(c,a.headers[c]);return a.mime&&b.overrideMimeType(a.mime),"function"==typeof a.before&&a.before.call(a.batch,b),b.send(a.data),b}a.prototype.toParams=c,a.prototype.extend=d,a.prototype.isObject=e,a.prototype.isArray=f,a.prototype.ajax=g,window.SharePointBatch=a}();
