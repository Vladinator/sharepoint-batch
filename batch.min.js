/*!
 * SharePointBatch
 * Copyright 2016 Alex Pedersen
 * Licensed under the MIT license
 * https://github.com/Vladinator89/sharepoint-batch
 */
!function(){"use strict";function e(t){function s(){for(var t="",s=0;s<this.jobs.length;s++){var e=this.jobs[s];e&&(t+=e.payload()+"\r\n")}return t}u(this,{options:u({url:"",digest:""},t),guid:p(),jobs:[],changesetSlots:100,append:function(i){u(i=u({guid:p(),method:"GET",url:"",headers:{},changesets:[],args:{}},i),{payload:s,toString:s});var r=[];l(i.changesets)&&i.changesets.length||(i.changesets=[null]);("GET"!==i.method?function(){var t="changeset_"+p();r.push("--batch_"+this.guid),r.push('Content-Type: multipart/mixed; boundary="'+t+'"'),r.push("Content-Transfer-Encoding: binary"),r.push("");for(var s=0;s<i.changesets.length;s++){var e=i.changesets[s];r.push("--"+t),r.push("Content-Type: application/http"),r.push("Content-Transfer-Encoding: binary"),r.push(""),r.push(i.method+" "+i.url+h(i.params)+" HTTP/1.1"),r.push("Accept: application/json;odata=verbose"),r.push("Content-Type: application/json;odata=verbose");var n=null!==e&&null!==e.data?JSON.stringify(e.data):null,o=i.headers;for(var a in null!==e&&u(o=u({},i.headers),e.headers),o)o.hasOwnProperty(a)&&r.push(a+": "+o[a]);r.push(""),n&&(r.push(n),r.push(""))}r.push("--"+t+"--")}:function(){r.push("--batch_"+this.guid),r.push("Content-Type: application/http"),r.push("Content-Transfer-Encoding: binary"),r.push("");for(var t=0;t<i.changesets.length;t++){for(var s in r.push(i.method+" "+i.url+h(i.params)+" HTTP/1.1"),r.push("Accept: application/json;odata=verbose"),i.headers)i.headers.hasOwnProperty(s)&&r.push(s+": "+i.headers[s]);r.push("")}}).call(this);var t=this.changesetSlots;{if((t-=i.changesets.length)<0)return-1;this.changesetSlots=t}return this.jobs.push(i)-1;function s(){return r.join("\r\n")}},remove:function(t){if("number"==typeof t)return this.jobs.splice(t,1)},payload:s,toString:s,send:function(t){var s=u({},t=u({method:"POST",url:this.options.url+"/_api/$batch",headers:{"X-RequestDigest":this.options.digest,"Content-Type":'multipart/mixed; boundary="batch_'+this.guid+'"'},data:this.payload()+"--batch_"+this.guid+"--"},t));return t.done=function(t){t.responseJSON=f.call(this,t.responseText),e.call(this,t.responseJSON),Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof s.done&&s.done.apply(this,arguments)},t.fail=function(t){t.responseJSON=f.call(this,t.responseText),e.call(this,t.responseJSON),Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof s.fail&&s.fail.apply(this,arguments)},t.always=function(t){Array.prototype.push.call(arguments,t.responseJSON),"function"==typeof s.always&&s.always.apply(this,arguments)},n.call(this,t);function f(t){if("string"!=typeof t)return null;try{return JSON.parse(t)}catch(t){}for(var s={UNKNOWN:0,HEADERS:1,REQUEST:2,REQUEST_HEADERS:3,REQUEST_BODY:4,EOF:5},e=t.split(/\r\n/),n=[],o=void 0,a=void 0,i=s.UNKNOWN,r=0;r<e.length;r++){var p=e[r];if(/^--batchresponse_.+--$/i.test(p)){void 0!==o&&(o.data=f.call(this,o.data),n.push(o),o=void 0),i=s.EOF;break}if(/^--batchresponse_.+$/i.test(p))void 0!==o&&(o.data=f.call(this,o.data),n.push(o)),a=o={headers:{},http:{status:0,statusText:""},data:void 0},i=s.HEADERS;else if(i===s.REQUEST_BODY)void 0===a.data&&(a.data=""),a.data+=p;else if(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i.test(p)){if(i===s.REQUEST){var h=p.match(/^HTTP\/1\.1\s+(\d+)\s+(.+)$/i);a.http.status=parseInt(h[1],10),a.http.statusText=h[2],i=s.REQUEST_HEADERS}}else if(/^.+:\s*.+$/i.test(p)){if(i===s.HEADERS||i===s.REQUEST_HEADERS){var u=p.split(/:/),c=u.shift(1).trim(),l=u.join(":").trim();a.headers[c]=l}}else/^[\s\r\n]*$/i.test(p)&&(i===s.HEADERS?i=s.REQUEST:i===s.REQUEST?i=s.REQUEST_HEADERS:i===s.REQUEST_HEADERS&&(i=s.REQUEST_BODY))}return n}function e(t){for(var s=0,e=0;e<this.jobs.length;e++){var n=this.jobs[e];if(l(n.changesetResults))for(;n.changesetResults.length;)n.changesetResults.pop();else n.changesetResults=[];for(var o=0;o<n.changesets.length;o++){var a=t[s++];c(a,!0)&&(a.job=n,a.changeset=o),n.changesetResults.push(a)}}}},spawn:function(t){return new e(u(u({},this.options),t))}})}function p(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var s=16*Math.random()|0;return("x"==t?s:3&s|8).toString(16)})}function h(t){var s="";if(c(t))for(var e in t)if(t.hasOwnProperty(e)){var n=t[e];if(l(n))for(var o=0;o<n.length;o++){var a=n[o];try{a=encodeURIComponent(a)}catch(t){a=""}s+=(""===s?"?":"&")+e+"[]="+a}else{try{n=encodeURIComponent(n)}catch(t){n=""}s+=(""===s?"?":"&")+e+"="+n}}return s}function u(t,s,e){var n,o,a,i=!0===t,r=i?s:t,p=i?e:s;if(c(r)||"function"==typeof r||(r={}),c(p))for(var h in p)o=p[h],n=r[h],a=l(o),o!==n&&(i&&o&&(c(o)||a)?u(i,r[h],o):void 0!==o&&(r[h]=o));return r}function c(t,s){return t&&"object"==typeof t&&(!s||!l(t))}function l(t){return Array.isArray(t)}function n(t){t=u({},t);var s=new XMLHttpRequest;if(t.batch=this,((s.options=t).xhr=s).addEventListener("progress",function(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.progress&&this.options.progress.apply(this.options.batch,arguments)}),s.addEventListener("load",function(){if(2!=(this.status/100|0))return n.apply(this,arguments);Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.done&&this.options.done.apply(this.options.batch,arguments);"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments);"function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)}),s.addEventListener("error",n),s.addEventListener("abort",n),s.open(t.method,t.url),s.setRequestHeader("Accept","application/json;odata=verbose"),c(t.headers))for(var e in t.headers)t.headers.hasOwnProperty(e)&&s.setRequestHeader(e,t.headers[e]);return t.mime&&s.overrideMimeType(t.mime),"function"==typeof t.before&&t.before.call(t.batch,s),s.send(t.data),s;function n(){Array.prototype.unshift.call(arguments,this),"function"==typeof this.options.fail&&this.options.fail.apply(this.options.batch,arguments),"function"==typeof this.options.always&&this.options.always.apply(this.options.batch,arguments),"function"==typeof this.options.after&&this.options.after.apply(this.options.batch,arguments)}}e.prototype.toParams=h,e.prototype.extend=u,e.prototype.isObject=c,e.prototype.isArray=l,e.prototype.ajax=n,window.SharePointBatch=e}();